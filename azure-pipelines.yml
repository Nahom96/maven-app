trigger:
  - main

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        pool:
          name: Default  # This matches your self-hosted agent pool name
        steps:
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'package'
              options: '-Dmaven.test.skip=true'
              mavenVersionOption: 'Default'
              javaHomeOption: 'Path'
              jdkDirectory: '/Library/Java/JavaVirtualMachines/microsoft-11.jdk/Contents/Home'  # ✅ Java 11 path on your Mac
              jdkArchitectureOption: 'x64'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'target/jenkins-webapp.war'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to LocalAgent'
    dependsOn: Build
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy WAR to Local Machine'
        environment: LocalAgent  # Make sure this matches the environment name in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop

                - task: CopyFiles@2
                  inputs:
                    SourceFolder: '$(Pipeline.Workspace)/drop'
                    Contents: '**/*.war'
                    TargetFolder: '/Users/nahom/DeployedApps'  # Folder on your machine

                - script: echo "✅ WAR file deployed to local folder!"
                  displayName: 'Deployment Confirmation'
