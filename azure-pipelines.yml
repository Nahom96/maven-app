trigger:
  - main

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        pool:
          name: Default  # This matches your self-hosted agent pool name
        steps:
          - task: Maven@4
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'install -DskipTests'
              options: '-Dmaven.test.skip=true'
              mavenVersionOption: 'Default'
              javaHomeOption: 'Path'
              jdkDirectory: '/Library/Java/JavaVirtualMachines/microsoft-11.jdk/Contents/Home'  # ✅ Java 11 path on your Mac
              jdkArchitectureOption: 'x64'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'target/jenkins-webapp.war'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to LocalAgent'
    dependsOn: Build
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy WAR to Local Machine'
        environment:
          name: LocalAgent   # This MUST match the environment you created in Azure
          resourceType: VirtualMachine
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop

                - script: |
                    mkdir -p /Users/nahom/DeployedApps
                    cp $(Pipeline.Workspace)/drop/*.war /Users/nahom/DeployedApps/
                  displayName: 'Copy WAR file to local folder'

                - script: echo "✅ WAR file successfully deployed to /Users/nahom/DeployedApps"
                  displayName: 'Deployment Confirmation'
